name: Google Drive & Sheets Workflow

on:
  # Run on schedule (example: daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      spreadsheet_id:
        description: 'Google Sheets Spreadsheet ID'
        required: false
        type: string
      drive_folder_id:
        description: 'Google Drive Folder ID'
        required: false
        type: string
      operation:
        description: 'Operation to perform (drive_to_sheets, sheets_to_drive, read_sheets, write_sheets)'
        required: false
        type: choice
        options:
          - drive_to_sheets
          - sheets_to_drive
          - read_sheets
          - write_sheets
          - custom
  
  # Run on push to main branch
  push:
    branches:
      - main
      - master
  
  # Run on pull request
  pull_request:
    branches:
      - main
      - master

jobs:
  run-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create credentials file
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          if [ -z "$GOOGLE_CREDENTIALS" ]; then
            echo "Error: GOOGLE_APPLICATION_CREDENTIALS secret is not set"
            exit 1
          fi
          echo "$GOOGLE_CREDENTIALS" > credentials.json
      
      - name: Run workflow script
        env:
          GOOGLE_APPLICATION_CREDENTIALS: credentials.json
          SPREADSHEET_ID: ${{ inputs.spreadsheet_id || secrets.DEFAULT_SPREADSHEET_ID }}
          DRIVE_FOLDER_ID: ${{ inputs.drive_folder_id || secrets.DEFAULT_DRIVE_FOLDER_ID }}
          DRIVE_FILE_ID: ${{ secrets.DEFAULT_DRIVE_FILE_ID }}
          OPERATION: ${{ inputs.operation || 'custom' }}
          RANGE_NAME: ${{ secrets.DEFAULT_RANGE_NAME || 'Sheet1!A1' }}
          SHEET_NAME: ${{ secrets.DEFAULT_SHEET_NAME }}
          OUTPUT_FILENAME: ${{ secrets.DEFAULT_OUTPUT_FILENAME || 'export.csv' }}
        run: |
          python workflow_runner.py
      
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f credentials.json
      
      - name: Upload logs (if needed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-logs
          path: |
            *.log
            credentials.json
          if-no-files-found: ignore

